# Техническая документация к проекту CarShare

## I. Общие положения

### 1. Назначение проекта
Программный продукт CarShare представляет собой сервис каршеринга (аренды автомобилей) с функцией автоматического поиска ближайших доступных автомобилей. Система позволяет пользователям регистрироваться, находить автомобили по заданным параметрам, оформлять аренду и производить оплату. Администраторы системы могут управлять пользователями, автомобилями и просматривать статистику.

### 2. Описание предметной области
Система автоматизирует следующие бизнес-процессы:
- Регистрация и аутентификация пользователей
- Верификация пользователей администраторами
- Управление парком автомобилей (добавление, редактирование, изменение статуса)
- Поиск доступных автомобилей по географическим координатам и параметрам
- Оформление аренды автомобилей
- Управление платежами
- Генерация отчетов по пользователям

### 3. Основные требования к проекту

#### Функциональные требования:
- Регистрация пользователей с подтверждением email
- Аутентификация и авторизация по JWT токенам
- Управление профилем пользователя
- CRUD операции для автомобилей
- Поиск автомобилей по радиусу и характеристикам
- Оформление и завершение аренды
- Интеграция с платежной системой
- Административный интерфейс для управления данными
- Восстановление пароля через email
- Экспорт данных пользователей в Excel

#### Нефункциональные требования:
- Производительность: обработка запросов в течение 2 секунд
- Безопасность: хеширование паролей, JWT аутентификация, защита от SQL-инъекций
- Масштабируемость: модульная архитектура, возможность горизонтального масштабирования
- Надежность: обработка ошибок, логирование, валидация входных данных
- Поддержка веб-интерфейса (HTML/CSS/JavaScript)

### 4. Предположения и ограничения
- Используется SQLite база данных (может быть заменена на PostgreSQL/MySQL)
- Сервер отправки почты должен быть предварительно настроен
- Геопозиционирование автомобилей осуществляется через внешние системы
- Платежная система интегрируется через API
- Поддерживается только веб-интерфейс

---

## II. Архитектурные решения

### 1. Общая архитектура системы
Система построена по клиент-серверной архитектуре с использованием FastAPI:
```
Client → FastAPI Application → Routers → Controllers → Models → Database
```
Основные компоненты:
- **API Layer**: FastAPI приложение с маршрутизацией
- **Business Logic**: обработчики запросов в router файлах
- **Data Access**: SQLModel для работы с базой данных
- **Authentication**: JWT токены и OAuth2
- **Services**: утилиты для отправки почты, генерации отчетов

### 2. Архитектура MVC
- **Model**: SQLModel классы в `models.py`, представляющие сущности БД
- **View**: FastAPI эндпоинты, возвращающие JSON/HTML ответы
- **Controller**: Функции в router файлах, обрабатывающие бизнес-логику

Разделение ответственности:
- **Model**: Структура данных, валидация, бизнес-методы
- **View**: Представление данных в API формате
- **Controller**: Обработка запросов, вызов методов моделей, возврат ответов

### 3. Обоснование выбора технологий
- **FastAPI**: Высокая производительность, автоматическая документация, поддержка асинхронности
- **SQLModel**: Объединение возможностей SQLAlchemy и Pydantic, типизация
- **JWT**: Стандарт для безопасной аутентификации в REST API
- **Openpyxl**: Для генерации Excel отчетов
- **Pydantic**: Валидация данных и сериализация
- **SQLite**: Легковесная БД для прототипирования

---

## III. Моделируемые сущности (Model)

### 1. Структуры данных
Основные сущности базы данных:

#### User (Пользователь):
```python
id: int (PK)
hash_password: str
role: str (no_verify, verify, super_user, BAN)
email: str
first_name: str
last_name: str
surname: str
license: str
date_reg: datetime
temp_data: str (nullable)
```

#### Car (Автомобиль):
```python
id: int (PK)
brand: str
model: str
latitude: float
longitude: float
car_number: str
price_order: int
status: str (active, service, no_active)
```

#### Rent (Аренда):
```python
id: int (PK)
user_id: int (FK)
car_id: int (FK)
data_rent_start: datetime
data_rent_end: datetime (nullable)
status: str (continues, end)
```

#### Payment (Платеж):
```python
id: int (PK)
rent_id: int (FK)
user_id: int (FK)
prise: int
card_number: str
data: datetime
status: str (waiting, payment)
```

### 2. Логика обработки данных
- Хеширование паролей с помощью SHA256
- Валидация входных данных через Pydantic схемы
- Автоматическая генерация даты регистрации
- Проверка прав доступа по ролям пользователей
- Бизнес-методы в моделях (verify_user, ban_user, service, active и т.д.)

### Хранение и обработка данных
- Данные хранятся в SQLite базе данных
- Используется SQLModel ORM для работы с БД
- Сессии БД управляются через контекстные менеджеры
- Конфигурация подключения вынесена в ```.env```

---

## IV. Представление (View)
### 1. Пользовательские интерфейсы
- Веб-интерфейс реализован через HTML шаблоны в директории templates
- API интерфейс возвращает JSON ответы
- Административный интерфейс доступен по специальным маршрутам

### 2. Форматы вывода данных
- API: JSON форматы, определенные в Pydantic схемах
- Web: HTML страницы с CSS стилизацией
- Reports: Excel файлы (xlsx) с данными пользователей
- Images: JPEG изображения (мемы)

### 3. UI-функционал
- Формы регистрации и аутентификации
- Интерактивные карты для отображения автомобилей
- Таблицы с данными и пагинацией
- Модальные окна для подтверждения действий
- Адаптивный дизайн для мобильных устройств

---

## V. Контроллеры (Controller)
### 1. Управление потоком действий
Маршрутизация организована через FastAPI роутеры:
- user.py: операции с пользователями
- car_and_rent.py: управление автомобилями и арендой
- payment.py: обработка платежей
- admin.py: административные функции
- Веб-роутеры в web/: HTML интерфейсы

Жизненный цикл запроса:
```
HTTP Request → FastAPI App → Router → Dependency Injection → 
→ Controller Function → Database Operation → Response
```

### 2. Реализация обработчиков событий
- CRUD операции для всех сущностей
- Фоновая отправка email через BackgroundTasks
- Асинхронная загрузка изображений
- Поиск автомобилей с расширяющимся радиусом
- Валидация данных на уровне контроллера

### 3. Безопасность контроллеров
- Аутентификация: JWT токены через OAuth2PasswordBearer
- Авторизация: проверка ролей пользователей
- Валидация: Pydantic схемы для всех входных данных
- Защита данных: хеширование паролей, маскирование платежной информации
- Обработка ошибок: единый обработчик HTTP исключений


